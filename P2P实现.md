### P2P 实现方法

我们采用了 WebRTC (Web Real-Time Communication) 技术来实现客户端之间的 P2P（点对点）直接通信。但是，P2P 连接的建立过程有一个“先有鸡还是先有蛋”的问题：两个客户端在能直接对话之前，必须先通过一个“中间人”来交换一些基本信息，比如各自的网络地址（IP、端口）、支持的编解码器等。这个交换信息的过程被称为“信令”（Signaling）。

我们的实现步骤如下：

1.  **信令服务器**：我们利用项目已有的 **WebSocket 连接**作为信令服务器。当用户A想要与用户B进行P2P聊天时，所有初始的连接设置信息（比如 SDP Offer/Answer, ICE Candidates）都会通过我们的 Flask-SocketIO 后端进行转发。服务器在这里只扮演“邮差”的角色，负责传递“信封”，但并不会（也无法）读取信件内容。

2.  **连接发起**：
    *   用户A（发起方）在 `ChatView.vue` 中创建一个 WebRTC 连接对象。
    *   A 生成一个 "Offer"（提议），其中包含了 A 的网络信息和会话能力。
    *   A 通过 WebSocket 将这个 "Offer" 发送给 B（经由服务器转发）。

3.  **连接应答**：
    *   用户B 收到 A 的 "Offer"。
    *   B 创建一个 "Answer"（应答），其中包含了自己的网络信息。
    *   B 通过 WebSocket 将 "Answer" 发回给 A。

4.  **NAT 穿透**：在交换 Offer/Answer 的同时，双方还会通过 ICE (Interactive Connectivity Establishment) 协议探测并交换所有可能的网络路径。这使得即使双方都在复杂的内网（NAT）环境下，也能大概率找到一条可以相互通信的路径。

5.  **建立连接**：一旦双方成功交换了必要信息并找到了可用路径，一个直接的、加密的 P2P 数据通道 (`RTCDataChannel`) 就会在两个客户端之间建立起来。此后的所有聊天消息都将通过这个通道直接发送，不再经过服务器。

**技术升级**：在开发过程中，我们发现手动管理 WebRTC 的信令流程非常复杂且容易出错。因此，我们决定引入 `PeerJS` 库。`PeerJS` 极大地简化了 WebRTC 的使用，它将复杂的信令交换和连接管理过程封装起来，我们只需要调用简单的 API 即可建立和管理 P2P 连接，让代码更简洁、更稳定。

---

### 加密通信的实现

**是的，加密通信是整个 P2P 设计的核心，我们实现了端到端加密（E2EE）的完整方案。**

这个方案严格遵循了您在 `需求.txt` 中提出的要求：“**采用非对称密码体制协商加密秘钥，用对称密码算法进行加解密**”。这确保了即使是我们的服务器，也无法窃听用户的聊天内容。

具体实现流程如下：

1.  **生成密钥对（非对称加密）**：
    *   当用户首次登录成功时，我们在前端使用浏览器的 `Web Crypto API` 为该用户生成一对唯一的、高强度的 **RSA 公私钥**。
    *   **公钥** 被上传到我们的后端服务器，以便其他用户可以请求获取。
    *   **私钥** **绝对不会离开用户的设备**。它被安全地存储在浏览器的 `localStorage` 中，与当前登录的用户绑定。

2.  **协商会话密钥（密钥交换）**：
    *   当用户 A 想要与用户 B 开始聊天时，A 会先从服务器获取 B 的**公钥**。
    *   然后，A 会在本地生成一个用于本次聊天的一次性的、高效率的**对称密钥**（例如 AES 密钥）。
    *   A 使用 B 的**公钥**来加密这个刚生成的**对称密钥**。

3.  **安全发送会话密钥**：
    *   A 将这个被加密后的对称密钥通过 P2P 通道发送给 B。
    *   因为只有 B 才拥有自己的**私钥**，所以只有 B 才能解密这条消息，从而安全地获得这个对称密钥。

4.  **加密通信（对称加密）**：
    *   现在，A 和 B 都拥有了同一个秘密的对称密钥。
    *   在此次会话中，双方之后所有的聊天消息，都会使用这个对称密钥进行加密和解密。由于对称加密算法（如 AES）的计算效率远高于非对称加密（如 RSA），这非常适合即时通讯的大量数据传输。

通过这个流程，我们实现了真正的端到端加密。密钥协商过程的安全性由非对称加密保证，而实时通信的效率由对称加密保证。服务器只参与了公钥的分发，对真正的通信内容（以及用于加密内容的对称密钥）一无所知。