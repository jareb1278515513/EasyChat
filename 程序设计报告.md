# 程序设计报告

## 项目概述
本项目是一个具有实时通信功能的Web应用，包含：
- 用户认证与管理
- 实时聊天功能
- 端到端加密通信
- 文件隐写传输

## 模块设计与函数清单

### 后端API模块

#### 认证模块 (auth.py)
- 函数名：token_required(f)
  - 功能说明：JWT认证装饰器
  - 功能流程：
    1. 从Authorization头获取token
    2. 验证token有效性
    3. 验证用户是否存在
    4. 将当前用户存入g对象
  - 异常处理：
    - 401: token缺失/过期/无效
    - 401: 用户不存在
  - 文件位置：backend/app/api/auth.py

- 函数名：admin_required(f)
  - 功能说明：管理员权限装饰器(继承token_required)
  - 额外功能：
    1. 验证用户is_admin标志
  - 异常处理：
    - 403: 非管理员用户
  - 文件位置：backend/app/api/auth.py

#### 好友管理模块 (friends.py)
- 函数名：get_friends()
  - 功能说明：获取当前用户的好友列表
  - 返回数据：好友ID、用户名、在线状态和连接信息
  - 排序方式：按添加时间排序
  - 文件位置：backend/app/api/friends.py

- 函数名：send_friend_request()
  - 功能说明：发送好友请求
  - 业务逻辑：
    1. 检查不能添加自己为好友
    2. 检查目标用户是否存在
    3. 检查是否已是好友
    4. 检查是否已有待处理请求
    5. 创建新请求并发送WebSocket通知
  - 返回状态：
    - 201: 请求发送成功
    - 400: 无效请求
    - 404: 用户不存在
  - 文件位置：backend/app/api/friends.py

- 函数名：get_friend_requests()
  - 功能说明：获取收到的好友请求
  - 返回数据：请求ID、发送者信息
  - 过滤条件：仅包含pending状态的请求
  - 文件位置：backend/app/api/friends.py

- 函数名：respond_to_friend_request(request_id)
  - 功能说明：处理好友请求(接受/拒绝)
  - 参数：
    - request_id: 请求ID
    - action: accept/reject
  - 业务逻辑：
    1. 验证请求状态必须为pending
    2. 接受请求会建立双向好友关系
    3. 拒绝请求仅更新状态
  - 文件位置：backend/app/api/friends.py

- 函数名：remove_friend(friend_id)
  - 功能说明：删除好友关系
  - 业务逻辑：
    1. 解除双向好友关系
    2. 删除相关请求记录
  - 返回状态：
    - 200: 删除成功
    - 400: 非好友关系
    - 404: 用户不存在
  - 文件位置：backend/app/api/friends.py

#### 用户管理模块 (users.py)
- 函数名：ping()
 - 功能说明：简单检查接口
 - 返回数据："Pong!"
 - 文件位置：backend/app/api/users.py

- 函数名：register()
 - 功能说明：用户注册
 - 业务逻辑：
   1. 验证必填参数
   2. 检查用户名/邮箱唯一性
   3. 创建用户并加密密码
 - 返回状态：
   - 201: 注册成功
   - 400: 参数缺失/用户名或邮箱已存在
 - 文件位置：backend/app/api/users.py

- 函数名：login()
 - 功能说明：用户登录
 - 业务逻辑：
   1. 验证凭证
   2. 更新用户IP和端口
   3. 生成JWT令牌(24小时有效期)
 - 返回状态：
   - 200: 登录成功(返回token)
   - 400: 参数缺失
   - 401: 凭证无效
 - 文件位置：backend/app/api/users.py

- 函数名：upload_key()
 - 功能说明：上传用户公钥
 - 权限控制：@token_required
 - 业务逻辑：
   1. 验证JWT
   2. 保存RSA公钥
 - 返回状态：
   - 200: 保存成功
   - 400: 参数缺失
 - 文件位置：backend/app/api/users.py

- 函数名：get_public_key(username)
 - 功能说明：获取指定用户公钥
 - 权限控制：@token_required
 - 业务逻辑：
   1. 查询目标用户
   2. 验证公钥存在
 - 返回状态：
   - 200: 返回公钥信息
   - 404: 用户不存在/未上传公钥
 - 文件位置：backend/app/api/users.py

- 函数名：update_email()
 - 功能说明：更新用户邮箱
 - 权限控制：@token_required
 - 业务逻辑：
   1. 验证新邮箱唯一性
   2. 更新邮箱
 - 返回状态：
   - 200: 更新成功
   - 400: 邮箱已被使用
 - 文件位置：backend/app/api/users.py

- 函数名：update_password()
 - 功能说明：更新用户密码
 - 权限控制：@token_required
 - 业务逻辑：
   1. 验证旧密码
   2. 加密新密码
 - 返回状态：
   - 200: 更新成功
   - 400: 参数缺失
   - 401: 旧密码错误
 - 文件位置：backend/app/api/users.py

#### 在线状态模块 (online.py)
- 函数名：get_user_info(username)
 - 功能说明：获取用户在线状态和连接信息
 - 权限控制：@token_required
 - 业务逻辑：
   1. 验证目标用户存在
   2. 检查当前用户是否有权限(自己或好友)
   3. 返回不同级别的信息：
      - 所有人可见：用户名和在线状态
      - 仅好友可见：IP和端口信息
 - 返回状态：
   - 200: 成功返回信息
   - 403: 无权限查看
   - 404: 用户不存在
 - 文件位置：backend/app/api/online.py

#### WebSocket认证模块 (auth_socket.py)
- 函数名：token_required_socket(f)
  - 功能说明：WebSocket连接JWT认证装饰器
  - 与HTTP认证的主要区别：
    1. 支持双token位置：
       - 标准WebSocket连接：Authorization头
       - Socket.IO事件：事件数据中的token字段
    2. 静默错误处理：认证失败仅记录日志不中断连接
  - 业务逻辑：
    1. 尝试从headers获取token
    2. 失败时尝试从事件数据获取
    3. 验证token有效性
    4. 验证用户是否存在
    5. 将当前用户存入连接环境
  - 文件位置：backend/app/api/auth_socket.py

#### 管理员接口 (admin.py)
- 函数名：get_all_users()
  - 功能说明：获取系统中所有注册用户信息(包括ID、用户名、邮箱、在线状态、IP地址等)，仅管理员可访问
  - 权限控制：@admin_required装饰器
  - 返回格式：JSON数组
  - 文件位置：backend/app/api/admin.py

- 函数名：disconnect_user(username)
  - 功能说明：强制断开指定用户的连接
  - 业务逻辑：
    1. 验证用户存在
    2. 检查在线状态
    3. 通过WebSocket强制断开
    4. 处理状态不一致情况
  - 返回状态：
    - 200: 操作成功
    - 404: 用户不存在
    - 500: 状态不一致
  - 文件位置：backend/app/api/admin.py

- 函数名：delete_user(username)
  - 功能说明：删除指定用户(管理员不能删除自己)
  - 安全限制：当前用户不能删除自己
  - 返回状态：
    - 200: 删除成功
    - 400: 尝试删除自己
    - 404: 用户不存在
  - 文件位置：backend/app/api/admin.py

## 核心技术

### 前端技术
- Vue 3 组合式API
- WebSocket 实时通信
- WebRTC P2P连接
- Web Crypto API 加密
- Canvas 隐写术

### 后端技术
- Flask 轻量级框架
- SQLAlchemy ORM
- JWT 认证
- Socket.IO 实时通信
- RSA/AES 混合加密

## 数据安全
1. 传输层: TLS 1.3
2. 应用层: 
   - 消息端到端加密
   - 密钥动态协商
   - 消息完整性校验
3. 存储层:
   - 密码加盐哈希
   - 敏感数据加密存储

## 部署架构
- 前端: 静态资源托管
- 后端: 容器化部署
- 数据库: 主从复制
- 缓存: Redis集群