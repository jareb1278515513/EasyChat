### P2P 实现方法：使用 PeerJS 简化 WebRTC

本项目采用 **PeerJS** 库来建立和管理客户端之间的 P2P（点对点）连接。PeerJS 是一个强大的 JavaScript 库，它将复杂、繁琐的 WebRTC 连接过程封装成了简洁、易用的 API，让开发者可以轻松实现浏览器之间的直接数据通信。

#### PeerJS 是如何工作的？

虽然 PeerJS 让我们不必手动处理 WebRTC 的细节，但理解其背后的基本原理仍然很重要：

1.  **WebRTC 技术**: WebRTC 是现代浏览器内置的一套标准 API，允许网页在不需要任何中间服务器中转的情况下，直接在用户之间传输音视频或任意数据。但 WebRTC 本身只提供了建立连接的"零件"，并没有规定如何让两个素不相识的客户端找到对方并交换连接信息。这个交换信息的过程被称为"**信令 (Signaling)**"。

2.  **信令服务器**: 为了让两个客户端能够"认识"彼此，它们需要一个共同的"中间人"来传递信令。在我们的项目中，这个中间人就是我们已有的 **Flask-SocketIO 后端**。PeerJS 会自动生成所有必要的信令数据（如 Offer, Answer, ICE Candidates），我们只需要通过 WebSocket 将这些数据在客户端之间进行转发即可。

#### 在 EasyChat 中的具体实现流程

1.  **初始化与ID分配**: 当用户登录后，前端会调用 `initializePeer(username)`。这会初始化一个 PeerJS 实例，并使用用户的**用户名**作为其在P2P网络中的唯一ID。这个实例会自动连接到 PeerJS 提供的免费信令协调服务器（用于初始发现），同时我们也配置它使用我们自己的 WebSocket 后端进行好友间的信令交换。

2.  **连接请求**: 当用户 A 点击好友 B 的列表项时，A 的客户端会调用 `peer.connect('B的用户名')`。这个简单的命令会触发 PeerJS 在后台完成所有复杂的信令交换工作。

3.  **建立数据通道**: PeerJS 会利用我们的 WebSocket 连接，在 A 和 B 之间自动交换所有必要的 WebRTC 信令。一旦信令交换成功，一个直接的、加密的 `RTCDataChannel` 会在两个客户端之间建立起来。

4.  **直接通信**: 此后，所有聊天消息（无论是加密文本还是含密图片）都将通过这个 `RTCDataChannel` 直接从一个客户端发送到另一个客户端，不再经过我们的服务器。

通过使用 PeerJS，我们得以用更简洁、更稳健的代码实现了复杂的 P2P 通信，从而可以更专注于上层的业务逻辑，如端到端加密和信息隐藏功能的开发。

---

### 加密通信的实现

**是的，加密通信是整个 P2P 设计的核心，我们实现了端到端加密（E2EE）的完整方案。**

这个方案严格遵循了您在 `需求.txt` 中提出的要求："**采用非对称密码体制协商加密秘钥，用对称密码算法进行加解密**"。这确保了即使是我们的服务器，也无法窃听用户的聊天内容。

具体实现流程如下：

1.  **生成密钥对（非对称加密）**：
    *   当用户首次登录成功时，我们在前端使用浏览器的 `Web Crypto API` 为该用户生成一对唯一的、高强度的 **RSA 公私钥**。
    *   **公钥** 被上传到我们的后端服务器，以便其他用户可以请求获取。
    *   **私钥** **绝对不会离开用户的设备**。它被安全地存储在浏览器的 `localStorage` 中，与当前登录的用户绑定。

2.  **协商会话密钥（密钥交换）**：
    *   当用户 A 想要与用户 B 开始聊天时，A 会先从服务器获取 B 的**公钥**。
    *   然后，A 会在本地生成一个用于本次聊天的一次性的、高效率的**对称密钥**（例如 AES 密钥）。
    *   A 使用 B 的**公钥**来加密这个刚生成的**对称密钥**。

3.  **安全发送会话密钥**：
    *   A 将这个被加密后的对称密钥通过 P2P 通道发送给 B。
    *   因为只有 B 才拥有自己的**私钥**，所以只有 B 才能解密这条消息，从而安全地获得这个对称密钥。

4.  **加密通信（对称加密）**：
    *   现在，A 和 B 都拥有了同一个秘密的对称密钥。
    *   在此次会话中，双方之后所有的聊天消息，都会使用这个对称密钥进行加密和解密。由于对称加密算法（如 AES）的计算效率远高于非对称加密（如 RSA），这非常适合即时通讯的大量数据传输。

通过这个流程，我们实现了真正的端到端加密。密钥协商过程的安全性由非对称加密保证，而实时通信的效率由对称加密保证。服务器只参与了公钥的分发，对真正的通信内容（以及用于加密内容的对称密钥）一无所知。