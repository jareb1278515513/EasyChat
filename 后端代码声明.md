# EasyChat 后端代码声明文档

## 1. 开发环境

### 核心依赖
- Python 3.x
- Flask
- Flask-SocketIO
- Flask-SQLAlchemy
- Flask-Migrate
- PyJWT (JWT认证)
- bcrypt (密码加密)
- Werkzeug (用于安全文件名处理)

### 数据库支持
- **开发环境**: SQLite
- **生产环境**: 可通过环境变量 `DATABASE_URL` 配置其他SQL数据库。

## 2. 系统结构设计

### 总体架构
采用 **Flask + Flask-SocketIO** 的混合架构：
- **RESTful API**: 处理用户认证、好友管理、个人资料等无状态HTTP请求。
- **WebSocket**: 通过 Socket.IO 处理用户在线状态、好友请求通知等实时、双向的通信。

### 核心组件
1. **应用入口 (`run.py`)**: 初始化Flask应用和SocketIO服务器，并启动服务。
2. **配置管理 (`config.py`)**: 集中管理应用配置、密钥和数据库URI。
3. **数据模型 (`app/models.py`)**: 定义用户、好友关系、好友请求等所有数据库模型。
4. **API路由 (`app/api/`)**: 蓝图化管理所有API端点，按功能划分为不同模块。
5. **实时通信 (`app/socket_events.py`)**: 封装所有Socket.IO事件的处理器。

## 3. 模块设计

### API模块划分 (`app/api/`)
- **用户模块 (`users.py`)**: 负责用户注册、登录、公钥管理、个人资料及头像更新。
- **好友模块 (`friends.py`)**: 负责好友列表获取、好友请求的发送与处理、删除好友。
- **管理模块 (`admin.py`)**: 提供管理员权限的接口，如查看所有用户、强制用户下线、删除用户等。
- **认证模块 (`auth.py`)**: 包含 `token_required` 装饰器，用于保护需要JWT认证的API端点。

### WebSocket事件 (`app/socket_events.py`)
- `connect`: 客户端连接成功时触发。
- `authenticate`: 客户端发送JWT进行身份验证。
- `disconnect`: 客户端断开连接，更新用户为离线状态。
- `notify_friend_request`: 当用户收到好友请求时，服务器主动推送通知。
- `notify_request_accepted`: 当好友请求被接受时，服务器通知请求方。
- `notify_friend_removed`: 当被好友删除时，服务器通知被删除方。

## 4. 重要数据结构设计

### 用户模型 (User)
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(128), nullable=False)
    is_online = db.Column(db.Boolean, default=False)
    ip_address = db.Column(db.String(45)) # 用于P2P
    port = db.Column(db.Integer) # 用于P2P
    public_key = db.Column(db.Text)
    is_admin = db.Column(db.Boolean, default=False)
    
    # --- 新增字段 ---
    gender = db.Column(db.String(10)) # 性别
    age = db.Column(db.Integer) # 年龄
    bio = db.Column(db.String(200)) # 个人简介
    avatar_url = db.Column(db.String(255)) # 头像文件路径

    friends = db.relationship(...)  # 好友关系(多对多)
    sent_friend_requests = db.relationship(...)
    received_friend_requests = db.relationship(...)
```

### 好友请求模型 (FriendRequest)
```python
class FriendRequest(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    requester_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    receiver_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    status = db.Column(db.String(20), default='pending') # 'pending', 'accepted', 'rejected'
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
```

### 好友关系表 (friendships)
- 一个用于实现用户之间多对多好友关系的中间表。

## 5. 程序函数清单

### 核心API函数

#### 用户模块 (`users.py`)
1.  `register()`: `POST /register` - 注册新用户。
2.  `login()`: `POST /login` - 用户登录，验证凭证并返回JWT。
3.  `upload_key()`: `POST /keys` - 上传当前用户的公钥。
4.  `get_public_key()`: `GET /users/<username>/public_key` - 获取指定用户的公钥。
5.  `update_email()`: `PUT /user/email` - 更新当前用户的邮箱。
6.  `update_password()`: `PUT /user/password` - 更新当前用户的密码。
7.  **`get_user_profile()`**: `GET /users/<username>/profile` - **(新增)** 获取指定用户的公开个人资料。
8.  **`update_profile()`**: `PUT /user/profile` - **(新增)** 更新当前用户的个人资料 (性别、年龄、简介)。
9.  **`upload_avatar()`**: `POST /user/avatar` - **(新增)** 为当前用户上传新的头像图片。

#### 好友模块 (`friends.py`)
1.  `get_friends()`: `GET /friends` - 获取当前用户的好友列表。
2.  `send_friend_request()`: `POST /friend-requests` - 向指定用户发送好友请求。
3.  `get_friend_requests()`: `GET /friend-requests` - 获取所有收到的待处理好友请求。
4.  `respond_to_friend_request()`: `PUT /friend-requests/<request_id>` - 响应 (接受/拒绝) 好友请求。
5.  `remove_friend()`: `DELETE /friends/<friend_id>` - 移除一个好友。

#### 管理员模块 (`admin.py`)
1.  `get_all_users()`: `GET /admin/users` - 获取所有用户的列表。
2.  `disconnect_user()`: `POST /admin/users/<username>/disconnect` - 强制指定用户下线。
3.  **`delete_user()`**: `DELETE /admin/users/<user_id>` - **(新增)** 从数据库中永久删除一个用户及其所有关联数据。

### WebSocket事件处理器 (`socket_events.py`)
1.  `handle_connect()`: 处理新客户端连接。
2.  `handle_authenticate()`: 使用JWT验证客户端身份，并将其加入其私有房间。
3.  `handle_disconnect()`: 处理客户端断连，更新数据库中用户的在线状态。
4.  **(无特定事件)**: 服务器通过 `socketio.emit()` 向特定用户的房间推送通知 (如 `new_friend_request`)，实现实时更新。