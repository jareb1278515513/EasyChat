# EasyChat 后端代码声明文档

## 1. 开发环境

### 核心依赖
- Python 3.x (推荐3.8+)
- Flask 2.1.2 (Web框架)
- Flask-SocketIO 5.3.6 (WebSocket支持)
- Flask-SQLAlchemy 2.5.1 (ORM)
- Flask-Migrate 3.1.0 (数据库迁移)
- PyJWT (JWT认证)
- bcrypt (密码加密)

### 数据库支持
- SQLite (开发环境默认)
- 支持其他SQL数据库(通过修改DATABASE_URL环境变量)

## 2. 系统结构设计

### 总体架构
采用Flask + SocketIO的混合架构：
- RESTful API处理常规HTTP请求
- WebSocket处理实时通信

### 核心组件
1. **应用入口**：run.py
   - 初始化应用
   - 启动SocketIO服务器

2. **配置管理**：config.py
   - 基础配置
   - 测试环境配置
   - 环境变量支持

3. **数据模型**：models.py
   - 用户模型(User)
   - 好友关系模型(FriendRequest)

4. **实时通信**：socket_events.py
   - 连接管理
   - 认证处理
   - 消息路由

5. **API路由**：
   - 用户认证(users.py)
   - 好友管理(friends.py)
   - 管理员功能(admin.py)

## 3. 模块设计

### API模块划分

#### 用户认证模块 (users.py)
- `/register` - 用户注册
- `/login` - 用户登录(JWT令牌发放)
- `/keys` - 公钥管理

#### 好友管理模块 (friends.py)
- `/friends` - 好友列表
- `/friend-requests` - 好友请求管理
- `/friends/<id>` - 好友关系维护

#### 管理员模块 (admin.py)
- `/admin/users` - 用户管理
- `/admin/users/<username>/disconnect` - 强制下线

#### WebSocket模块 (socket_events.py)
- `connect` - 连接建立
- `authenticate` - Socket认证
- `disconnect` - 连接断开
- `private_message` - 私聊消息

## 4. 重要数据结构设计

### 用户模型(User)
```python
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True)
    email = db.Column(db.String(120), unique=True)
    password_hash = db.Column(db.String(128))
    is_online = db.Column(db.Boolean, default=False)
    ip_address = db.Column(db.String(45))
    port = db.Column(db.Integer)
    public_key = db.Column(db.Text)
    is_admin = db.Column(db.Boolean, default=False)
    friends = db.relationship(...)  # 好友关系
```

### 好友请求模型(FriendRequest)
```python
class FriendRequest(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    requester_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    receiver_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    status = db.Column(db.String(20), default='pending')
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
```

### 好友关系表
```python
friendships = db.Table('friendships',
    db.Column('user_id', db.Integer, db.ForeignKey('users.id')),
    db.Column('friend_id', db.Integer, db.ForeignKey('users.id'))
)
```

## 5. 程序函数清单

### 核心API函数

#### 用户认证
1. `register()`
   - 位置：app/api/users.py
   - 功能：用户注册
   - 参数：username(用户名), email(邮箱), password(密码)
   - 描述：接收JSON格式的注册信息，创建新用户并返回结果

2. `login()`
   - 位置：app/api/users.py
   - 功能：用户登录
   - 参数：username(用户名), password(密码)
   - 描述：验证用户凭证，成功则返回JWT令牌

3. `upload_key()`
   - 位置：app/api/users.py
   - 功能：上传公钥
   - 参数：public_key(公钥字符串)
   - 描述：允许认证用户上传自己的公钥

4. `get_public_key()`
   - 位置：app/api/users.py
   - 功能：获取用户公钥
   - 参数：username(目标用户名)
   - 描述：根据用户名查询对应用户的公钥

#### 好友管理
1. `get_friends()`
   - 位置：app/api/friends.py
   - 功能：获取好友列表
   - 参数：无
   - 描述：返回当前用户的所有好友信息，包括在线状态和连接信息

2. `send_friend_request()`
   - 位置：app/api/friends.py
   - 功能：发送好友请求
   - 参数：username(目标用户名)
   - 描述：向指定用户发送好友请求，并通过WebSocket通知对方

3. `get_friend_requests()`
   - 位置：app/api/friends.py
   - 功能：获取待处理请求
   - 参数：无
   - 描述：返回当前用户收到的所有待处理的好友请求

4. `respond_to_friend_request()`
   - 位置：app/api/friends.py
   - 功能：响应好友请求
   - 参数：request_id(请求ID), action(accept/reject)
   - 描述：接受或拒绝指定的好友请求

5. `remove_friend()`
   - 位置：app/api/friends.py
   - 功能：移除好友
   - 参数：friend_id(好友ID)
   - 描述：根据好友ID解除好友关系

#### 管理员功能
1. `get_all_users()`
   - 位置：app/api/admin.py
   - 功能：获取所有用户
   - 参数：无
   - 描述：返回系统中所有用户的详细信息列表

2. `disconnect_user()`
   - 位置：app/api/admin.py
   - 功能：强制下线用户
   - 参数：username(目标用户名)
   - 描述：通过用户名强制断开指定用户的WebSocket连接

### WebSocket事件处理器
1. `handle_connect()`
   - 位置：app/socket_events.py
   - 功能：处理新连接
   - 参数：无
   - 描述：处理客户端初始连接事件

2. `handle_authenticate()`
   - 位置：app/socket_events.py
   - 功能：处理认证
   - 参数：token(JWT令牌)
   - 描述：验证用户令牌，建立用户与会话的映射关系

3. `handle_disconnect()`
   - 位置：app/socket_events.py
   - 功能：处理断开
   - 参数：无
   - 描述：清理会话信息，更新用户离线状态

4. `handle_private_message()`
   - 位置：app/socket_events.py
   - 功能：处理私聊消息
   - 参数：to(接收者), message(消息内容)
   - 描述：验证接收者并将消息转发到目标用户房间